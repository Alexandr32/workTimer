<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script type="text/javascript" src="vanilla-tilt.js"></script>
    <script type="text/javascript" src="moment.js"></script>
    <script type="text/javascript" src="moment-with-locales.js"></script>
</head>
<body class="dark-them">

<template id="templateDrop">
    <div class="drop"></div>
</template>

<div class="settings">
    <button>Время</button>
    <button id="switcherThem">Темная</button>
</div>

<div id="dialogTime" class="dialog-time">

    <div class="input-time">
        <label for="selectStartTime">Дата начала рабочего дня</label>
        <input id="selectStartTime" type="time">
    </div>

    <div class="input-time">
        <label for="selectFinishTime">Дата окончания рабочего дня</label>
        <input id="selectFinishTime" type="time">
    </div>

    <div class="dialog-button">
        <button id="caveDialogTime">Сохранить</button>
        <button id="closeDialogTime">Закрыть</button>
    </div>
</div>

<div class="timer">
    <div class="text-label">
        До конца рабочего дня осталось:
    </div>

    <div class="time">

        <div class="circle">
            <div id="hour" class="title">
                00
            </div>
            <div class="name">
                Часы
            </div>

            <div class="dots hh-dot dot-red"></div>

            <svg  height='100%' width='100%' class="svg">
                <circle cx="100" cy="100" r="70"></circle>
            </svg>

            <svg  height='100%' width='100%' class="svg red" id="hh-line">
                <circle cx="100" cy="100" r="70"></circle>
            </svg>

        </div>

        <div class="circle">

            <div id="minute" class="title">
                00
            </div>
            <div class="name">
                Минуты
            </div>

            <div class="dots hh-dot dot-yellow"></div>

            <svg  height='100%' width='100%' class="svg">
                <circle cx="100" cy="100" r="70"></circle>
            </svg>

            <svg  height='100%' width='100%' class="svg yellow" id="mm-line">
                <circle cx="100" cy="100" r="70"></circle>
            </svg>
        </div>

        <div class="circle">

            <div id="second" class="title">
                00
            </div>
            <div class="name">
                Секунды
            </div>

            <div class="dots hh-dot dot-green"></div>

            <svg  height='100%' width='100%' class="svg">
                <circle cx="100" cy="100" r="70"></circle>
            </svg>

            <svg  height='100%' width='100%' class="svg green" id="ss-line">
                <circle cx="100" cy="100" r="70"></circle>
            </svg>
        </div>

    </div>
</div>

</body>
</html>

<script>

    VanillaTilt.init(document.querySelectorAll('.timer'), {
        max: 25,
        speed: 400,
        scale: 1.2,
    });

    class Timer {
        constructor(hourElement, minuteElement, secondElement) {
            this.hourElement = hourElement
            this.minuteElement = minuteElement
            this.secondElement = secondElement
        }

        updateUI() {

            const now  = moment(new Date());
            const then = moment(new Date());
            then.set({
                hour:   17,
                minute: 30,
            });

            const ms = now.diff(then);
            const diff = moment.duration(ms);

            const currentHour = diff.hours()

            const currentMinute = diff.minutes()

            const currentSecond = diff.seconds()

            this.hourElement.innerHTML = currentHour
            this.minuteElement.innerHTML = currentMinute
            this.secondElement.innerHTML = currentSecond

            const hhLine = document.getElementById('hh-line')
            const mmLine = document.getElementById('mm-line')
            const ssLine = document.getElementById('ss-line')

            hhLine.style.strokeDashoffset = 440 - (440 * currentHour) / 12
            mmLine.style.strokeDashoffset = 440 - (440 * currentMinute) / 60
            ssLine.style.strokeDashoffset = 440 - (440 * currentSecond) / 60

            const dotRed = document.getElementsByClassName('dot-red')[0]
            const dotYellow = document.getElementsByClassName('dot-yellow')[0]
            const dotGreen = document.getElementsByClassName('dot-green')[0]

            dotRed.style.transform = `rotate(${currentHour * 30}deg)`
            dotYellow.style.transform = `rotate(${currentMinute * 6}deg)`
            dotGreen.style.transform = `rotate(${currentSecond * 6}deg)`
        }
    }

    class Rain {

        constructor(mainElement, templateDrop, amount) {

            this.mainElement = mainElement
            this.templateDrop = templateDrop
            this.amount = amount || 80
        }

        start() {
            for (let i = 0; i < this.amount; i++) {

                const drop = this.templateDrop.content.cloneNode(true).children[0]

                const size = Math.random() * 5
                const posX = Math.floor(Math.random() * window.innerWidth)
                const delay = Math.random() * -20
                const duration = Math.random() * -20

                drop.style.width = `${0.2 + size}px`
                drop.style.left = `${posX}px`
                drop.style.animationDelay = `${delay}s`
                drop.style.animationDuration = `1${duration}s`

                this.mainElement.append(drop)
            }
        }
    }

    class SettingService {

        #isDarkThemKey = 'isDarkThem'

        isDarkThem() {
            return localStorage.key(this.#isDarkThemKey) || false
        }

        darkThemOn() {
            localStorage.setItem(this.#isDarkThemKey, 'true');
        }

        darkThemOff() {
            localStorage.removeItem(this.#isDarkThemKey);
        }
    }

    class SwitcherThem {

        isDarkThem = true

        constructor(elementArray, clickElement, labelElement, settingService) {
            this.elementArray = elementArray
            this.labelElement = labelElement
            this.settingService = settingService

            this.isDarkThem = settingService.isDarkThem()

            this.switcher()

            clickElement.addEventListener('click', () => {
                this.isDarkThem = !this.isDarkThem
                this.switcher()
            })
        }

        switcher = () => {

            this.elementArray.forEach((item, i) => {
                if(this.isDarkThem) {
                    item.classList.remove("light-them");
                    item.classList.add("dark-them");
                    this.labelElement.innerHTML = 'Темная'
                    this.settingService.darkThemOn()

                } else {
                    item.classList.remove("dark-them");
                    item.classList.add("light-them");
                    this.labelElement.innerHTML = 'Лайт'
                    this.settingService.darkThemOff()
                }
            })

            this.labelElement.innerHTML = this.isDarkThem ? 'Темная' : 'Лайт'
        }

    }

    function main() {
        const timer = new Timer(
            document.getElementById('hour'),
            document.getElementById('minute'),
            document.getElementById('second'),
        )

        timer.updateUI()

        setInterval(() => {
            timer.updateUI()
        }, 1000)

        const body = document.querySelector('body')
        const rain = new Rain(body, templateDrop)
        rain.start()

        const switcherThemElement = document.getElementById('switcherThem')
        const settingsElement = document.getElementsByClassName('settings')[0]
        const timerElement = document.getElementsByClassName('timer')[0]
        const dialogTimeElement = document.getElementById('dialogTime')
        const selectStartTimeElement = document.getElementById('selectStartTime')
        const selectFinishTimeElement = document.getElementById('selectFinishTime')

        const elementsArray = [
            body,
            switcherThemElement,
            settingsElement,
            timerElement,
            dialogTimeElement,
            selectStartTimeElement,
            selectFinishTimeElement
        ]

        const settingService = new SettingService()

        new SwitcherThem(elementsArray, switcherThemElement, switcherThemElement, settingService)
    }

    main()


</script>